---
title: "Rank-sum ratio method"
vignette: >
  %\VignetteIndexEntry{Rank-sum ratio method}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
format:
  html:
    toc: true
    mathjax: true
    self-contained: true
knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
---

**秩和比法**（Rank-sum ratio，RSR）由田凤调教授于 1988 年提出，集古典参数统计与近代非参数统计各自优点于一体的统计分析方法。RSR 法现在广泛地应用于医疗卫生、科技、经济等邻域的多指标综合评价、统计预测预报、鉴别分类、统计质量控制等方面。

RSR 一般过程是将正向指标从小到大排序进行排名、负向指标从大到小排序进行排名，再计算秩和比，最后统计回归、分档排序。通过秩转换，获得无量纲统计量 RSR；在此基础上，运用参数统计分析的概念与方法，研究 RSR 的分布；以 RSR 值对评价对象的优劣直接排序或分档排序，从而对评价对象做出综合评价。

**优点：**以非参数法为基础，对指标的选择无特殊要求，适用于各种评价对象，由于计算时使用的数值是秩次，可以消除异常值的干扰

**缺点：**排序的主要依据是利用原始数据的秩次，最终算得的 RSR 值反映的是综合秩次的差距，而与原始数据的顺位间的差距程度大小无关，这样在指标转化为秩次是会失去一些原始数据的信息，如原始数据的大小差别等。当 RSR 值实际上不满足正态分布时，分档归类的结果与实际情况会有偏差，且只能回答分级程度是否有差别，不能进一步回答具体的差别情况。

**RSR 法本质**

RSR 只使用了数据的相对大小关系，而不真正运用数值本身，也能用于处理“好”、“较好”、“一般”这类模糊指标问题。只要选择恰当的权重，RSR 法也能转化为模糊综合评价。

实际上，只要确定了权重，编好了秩，原始样本的排序就结束了，但是 RSR 综合评价法再进行了统计回归、分档排序，这一步实际上是通过将样本的秩次分布映射到正态分布曲线上，运用正态分布 $3 \sigma$ 原则或其它连续变量离散化方法进行分档。

## 算法步骤

设有 $n$ 个评价对象，$m$ 个评价指标，形成原始指标数据矩阵 $X$，其中 $x_{ij}$ 表示第 $i$ 个评价对象第 $j$ 个指标的值。

### 编秩

**整数秩**

编出每个指标各评价对象的秩，其中正向指标从小到大编秩，负向指标从大到小编秩，同一指标数据相同者编平均秩。例如，某指标下第 3、4、5 名的值相同（原始应占秩次 3, 4, 5），则它们的秩次均为 $(3+4+5) / 3 = 4$。下一个不同的值则编为秩次 6。

**非整数秩**

用类似于线性插值的方式对指标值进行编秩，以改进 RSR 法编秩方法的不足，所编秩次与原指标值之间存在定量的线性对应关系，从而克服了 RSR 法秩次化时易损失原指标值定量信息的缺点。

对于正向指标：
$$
R_{ij}=1+(n-1)\dfrac{x_{ij}-\min\limits_i x_{ij}}{\max\limits_i x_{ij}-\min\limits_i x_{ij}}
$$

对于负向指标：
$$
R_{ij}=1+(n-1)\dfrac{\max\limits_i x_{ij}-x_{ij}}{\max\limits_i x_{ij}-\min\limits_i x_{ij}}
$$

非整数秩是将传统整数排名（如1, 2, 3, …）推广到连续区间的一种方法，其核心在于根据评价对象在数据中的相对位置，赋予其介于 $1$ 与 $n$ 之间的实数值，而非简单的整数秩次，从而更精细地刻画排名信息。该方法本质上是对原始数据进行线性归一化到 $[1,n]$  （即线性插值处理），使排名由跳跃式的离散值转变为反映个体间细微差异的连续变量，提升综合评价的灵敏度与准确性。

该步得到秩矩阵，记为 $R=(R_{ij})_{m\times n}$。

### 计算秩和比并排序

秩和比 $RSR_i$ 定义为第 $i$ 个评价对象在所有 $n$ 个指标下的秩和相对于最大可能秩次（为 $n$ ）的比例：
$$
RSR_i=\frac{1}{n}\sum^m_{j=1}w_jR_{ij}
$$
其中，$w_j$ 为第 $j$ 个指标的权重，满足 $\sum_j=1^m w_j=1$。

当指标权重相同时，$w_j\equiv\frac1m$，此时秩和比可以表示为：
$$
RSR_i=\frac{1}{mn}\sum^m_{j=1}R_{ij}
$$

### 确定 RSR 的分布（转化为概率单位）

RSR 的分布是指用概率单位 Probit 表达的值特定的累计频率。 Probit 模型是一种广义的线性模型，服从正态分布。其转换方法为：

(1) 编制 RSR 频数分布表，列出各组频数 $f_i$，计算各组累计频数 $cf_i$；
(2) 确定各组 RSR 的秩次范围及平均秩次；
(3) 计算累计频率 $p_i=cf_i/n\times100\%$，最后一项记为 $1-\frac1{4n}$ 进行修正。（使用离散分布作为正态分布的近似计算中，作些修正可以提高精度。这里若不做修正，得到的 $Probit\to\infty$，不能用于计算）
(4) 将累计频率换算为概率单位 $\mathrm{Probit}_i$，为累计频率对应的标准正态分布的 $p_i$ 分位数加
$5$。|

### 拟合线性回归模型，计算模型估计值

以累积频率所对应的概率单位 Probit 为自变量，以 RSR 值为因变量，计算直线回归方程，即：
$$
RSR = a+b * Probit
$$

回归方程需要做常规的回归诊断保证模型可用（略）。

计算线性回归模型的预测值：
$$
RSRfit_i = a + b * \text{Probit}_i
$$

### 进行分档排序

根据 $RSRfit_i$ 值对评价对象进行分档排序，分档数由研究者根据实际情况决定。

分档排序，实际上就是连续数值离散化，有很多种方法，只要合理就行。

## 案例：孕产妇保健评价

加载包：

```{r message=FALSE}
library(tidyverse)
library(mathmodels)
```


### 准备数据

对某省 $10$ 个地区孕产妇保健工作就 $3$ 个指标（产前检查率($\%$)、 孕妇死亡率($1/10$万)、围产儿死亡率($\%$)），进行秩和比综合评价。

```{r}
df = tibble(
  ID = LETTERS[1:10],
  x1 = c(99.54,96.52,99.36,92.83,91.71,95.35,96.09,99.27,94.76,84.80),
  x2 = c(60.27,59.67,43.91,58.99,35.40,44.71,49.81,31.69,22.91,81.49),
  x3 = c(16.15,20.10,15.60,17.04,15.01,13.93,17.43,13.89,19.87,23.63))
df
```

数据预处理，`x2` 和 `x3` 是负向指标，取倒数即可（不影响编秩）：

```{r}
df1 = df |> 
  mutate(across(x2:x3, \(x) 1 / x))
```

### 秩和比法评价

`mathmodels` 包提供了 `rank_sum_ratio()` 函数实现用秩和比法综合评价，基本语法：

```{r eval=FALSE}
rank_sum_ratio(data, w = NULL, method = "int")
```

- `data` 为原始指标数据，首列为评价对象 ID；
- `w` 为指标权重，可以通过各种赋权法得到，默认是等权重；
- `method` 设置编整数秩（`"int"`）还是非整数秩（`"non-int"`） 。

### 重现经典案例结果

采用等指标权重、编整数秩：

```{r}
res = rank_sum_ratio(df1)  
```

- 查看结果表（包含中间结果）：

```{r}
res$resultTable
```

- 查看编秩结果：

```{r}
res$rankTable
```


- 查看线性回归模型：

```{r}
res$reg
```

可以进一步提取回归模型的各种结果（略）。

### 更一般做法

- 指标权重采用熵权法，注意应该根据原始数据计算：

```{r}
rlt = entropy_weight(df[-1], c("+","-","-"))
rlt$w
```

- 采用非整数秩，注意，此时负向指标正向化处理更适合采用"最大值减"而不是"取倒数"：

```{r}
df2 = df |>
  mutate(across(x2:x3, \(x) max(x) - x))
res = rank_sum_ratio(df2, rlt$w, "non-int")
```

- 查看结果表：

```{r}
res$resultTable
```


其它结果略。


