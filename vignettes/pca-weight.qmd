---
title: "PCA-Based Weighting Method"
vignette: >
  %\VignetteIndexEntry{PCA-Based Weighting Method}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
format:
  html:
    toc: true
    mathjax: true
    self-contained: true
knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
---

**主成分分析（PCA）**，是一种多元统计分析方法，其核心思想是在损失很少信息的前提下，将多个原始指标转化为少数几个综合指标。这些转化后的综合指标称为主成分，每个主成分都是原始变量的线性组合，且彼此之间互不相关。这使得主成分在解释数据变异时具有更强的独立性和代表性。因此，主成分比原始变量在某些方面具有更为优越的性能。

主成分法赋权，是一种完全基于数据自身特征（如相关性、方差）来确定权重的客观赋权法。 其核心思想是：利用主成分的方差贡献率和载荷（特征向量）来综合确定各原始指标的权重。方差贡献率反映了主成分包含原始数据信息量的多少，载荷则反映了原始指标与主成分之间的相关程度。

当用于综合评价时，若选取的指标较多，且存在一定的相关性，那么不同指标所反映的信息可能具有一定程度的重叠。此时使用主成分法赋权，能够有效避免主观判断带来的随机干扰，同时减少指标间信息重复的问题，使评价体系更加科学、客观。

对于主成分分析，在所有线性组合中，第一主成分 $F_1$ 是方差最大的组合，称为第一主成分；如果第一主成分不足以代表原始数据的全部信息，则引入第二主成分 $F_2$，并要求 $F_2$ 在包含尽可能多的新信息的同时，不再重复 $F_1$ 的信息。用数学语言表示就是：$COV(F_1, F_2) = 0$。依此类推，可以构造出第 $3$ 个、第 $4$ 个......第 $p$ 个主成分，直至累计方差贡献率达到满意水平。

关于主成分个数的选择：

- 使用全部主成分：主成分赋权的目的不是降维，如果数据质量较高，应该保留全部主成分，因为这样不丢失信息
- 按照 PCA 原则，选择部分主成分：好处是降噪和提高权重的解释性。

## 算法步骤

设有 $n$ 个评价对象，$m$ 个评价指标，形成原始指标数据矩阵，其中 $x_{ij}$ 表示第 $i$ 个评价对象第 $j$ 个指标的值。

#### (1) 无量纲处理：标准化

由于指标通常具有不同的量纲和数量级，必须对原始数据进行预处理以消除量纲影响。主成分分析通常使用标准化：
$$
z_{ij} = \frac{x_{ij} - \mu_j}{\sigma_j}
$$
其中，$\mu_j$ 和 $\sigma_j$ 分别为第 $j$ 个指标列的均值和标准差。

对于负向指标，通常建议在标准化后乘以 $-1$ 进行正向化处理。

注意，这样做的目的是确保在后续的综合得分计算中，所有指标的方向一致（越大越好），避免因指标方向不一致导致综合得分逻辑错误。

这样就得到标准化数据矩阵 $Z = (z_{ij})_{n \times m}$，每列均值为 $0$，标准差为 $1$。

#### (2) 计算协方差矩阵

计算标准化数据矩阵 $Z$ 的协方差矩阵，也即原始数据矩阵的相关系数矩阵
$$
R = \frac{1}{n - 1} Z^T Z
$$

#### (3) 特征分解

对矩阵 $R$ 进行特征分解：
$$
R=U\Lambda U^T
$$

- $\Lambda = \mathrm{diag}(\lambda_1,\cdots,\lambda_m)$ 是特征值矩阵，满足 $\lambda_1 \geq \lambda_2 \geq \cdots \geq \lambda_m \geq 0$。
- $U=[u_1,\cdots,u_m]$ 是正交化单位特征向量矩阵，满足 $U^T U = I$。

#### (4) 载荷矩阵

$$
A = [a_{ji}]_{m \times m} = \big[u_{ji} \sqrt{\lambda_i}\big]_{m \times m}, \qquad i,j =1,\cdots,m
$$
其中，$a_{ji}$ 表示指标 $j$ 在主成分 $i$ 上的载荷（相关系数）。

旋转后载荷矩阵（可选）: $A_\mathrm{rot} = \mathrm{Varimax}(A_m\times p)$

- 对前 $p\leq m$ 个主成分的载荷矩阵 $A_{m\times p}$ 应用 Varimax 旋转（若 $p>1$ 且启用旋转）。

- $a_{ji}^\mathrm{rot}$ 是旋转后载荷，增强解释性。

- 若无旋转或 $p=1$，则 $A_\mathrm{rot}=A_{m\times p}$。

**注：**PCA 通常取累计贡献率达到 $85\%$ 以上，或特征值 $>1$，或基于碎石图、平行分析，选择前 $p$ 个主成分。

#### (5) 方差贡献率与累积方差贡献率

计算每个主成分的方差贡献率和前 $p$ 个主成分的累计方差贡献率。
$$
\eta_j = \frac{\lambda_j}{\sum_{k=1}^m \lambda_k}, \quad j = 1,\cdots,m
$$
$$
\alpha_p = \sum\limits_{j=1}^p \eta_j
$$

#### (6) 指标权重

依据指标载荷值（反映该指标与该主成分之间的相关性）和对应的方差贡献（衡量其在总方差中的占比），计算指标在所选主成分中的重要性，通常有两种做法：

**绝对值法**（更常用，平衡各指标贡献）：$\beta_j = \sum\limits_{i=1}^p \eta_i |a^{\text{rot}}_{ji}|$

**平方法**（突出主导指标）：$\beta_j = \sum\limits_{i=1}^p \eta_i [a^{\text{rot}}_{ji}]^2$

再归一化得到指标权重：
$$
w_j = \dfrac{\beta_j}{\sum_{k=1}^m \beta_k}, \quad j=1,\cdots,m
$$

#### (7) 综合得分

基于指标权重和标准化后的数据，计算各评价对象的综合得分：
$$
s_i = \sum\limits_{j=1}^m w_j z_{ij}, \quad i=1,\cdots,n
$$

## 案例：河流水质数据

加载包：

```{r message=FALSE}
library(tidyverse)
library(mathmodels)
```

### 准备数据

使用内置的 `water_quality` 数据来演示：

```{r}
water_quality
```

这是 $20$ 条河流的水质数据，含氧量越高越好（正向指标）；PH 值越接近 $7$ 越好（居中型指标）；细菌总数越少越好（负向指标）；植物性营养物量介于 $10 \sim 20$ 之间最佳（区间型指标）。

### 数据预处理

借助 `mathmodels` 包提供的预处理函数，使用 `mutate()` 修改列即可。只需要处理居中型和区间型指标，因为指标标准化已内置到主成分赋权法函数。

```{r}
df = water_quality |>
  mutate(PH = rescale_middle(PH, 7), 
         nutrient = rescale_interval(nutrient, 10, 20))
df
```

### 主成分赋权

用 `pca_weight()` 函数实现用**主成分法**计算权重，该函数已内置标准化处理，基本语法：

```{r eval=FALSE}
pca_weight(X, index = NULL, nfs = NULL, varimax = TRUE, method = "abs")
```

- `index` 可以指定对哪些列做正向（`"+"`）、负向（`"-"`）、不做（`NA`）标准化；
- `nfs` 选择主成分数，默认为全部主成分（即 `X` 的列数）；
- `varimax` 设置是否对载荷矩阵做正交最大旋转，默认为 `TRUE`； 
- `method` 设置计算指标权重使用载荷的方法：`"abs"`（默认，绝对值法）、`"squared"`（平方法）。

两个已经归一化的指标仍做标准化，`germ` 为负向指标，选择 $3$ 个主成分，做主成分赋权：

```{r}
idx = c("+", "+", "-", "+")
res = pca_weight(df[-1], idx, nfs = 3)
```

- 查看指标权重：

```{r}
res$w
```

- 查看各个评价对象得分：

```{r}
res$s
```

- 查看 $3$ 个主成分的累积贡献：

```{r}
res$cum_contrib
```


- 查看旋转的载荷矩阵：

```{r}
res$loading
```

可以据此，解释这 $3$ 个主成分（略）。
