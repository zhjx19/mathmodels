---
title: "Data Envelopment Analysis"
vignette: >
  %\VignetteIndexEntry{Data Envelopment Analysis}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
format:
  html:
    toc: true
    mathjax: true
    self-contained: true
knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
---

**数据包络分析（DEA）**，是一种基于线性规划的非参数评估方法。它通过构建相对效率评价模型，对多个具有多投入、多产出特征的决策单元（DMU）进行绩效评估和效率排序。DEA 的核心优势在于，它能够根据每个决策单元自身的投入和产出数据，自动优化其权重配置。这种方法无需事先设定固定的权重，从而能够更客观、真实地识别出对每个决策单元最有利的评价标准，准确反映其个体特征和实际运行效率。 

DEA 已被广泛应用于生产管理、行政绩效评估等诸多领域。它不仅可以用于评估不同方案的相对有效性，例如投资项目的效益比较，还可以在决策前进行效果预测，或在政策实施后评估其成效。通过 DEA 的辅助，决策者能够更科学地制定策略，提升管理和决策的精准性。

**DEA 优点：**

(1) 多指标处理能力：DEA 擅长处理多输入和多输出指标的综合评价问题，适用于复杂系统的效率评估。
(2) 无需无量纲化：DEA 不对数据进行无量纲化处理，因为其效率指标的计算与输入输出数据的量纲无关。
(3) 客观性强：DEA 无需事先设定权重，而是根据实际数据计算最优权重，减少了主观因素的干扰，提高了评估的客观性。
(4) 灵活的关系建模：DEA 假定输入和输出之间存在某种联系，但不需要明确表达这种关系的具体形式，从而增加了模型的灵活性。

**DEA 缺点：**

(1) 数据依赖性：DEA 的效率评估结果依赖于所收集的数据，最优效率仅在当前样本范围内有效。
(2) 技术有效单元的局限性：DEA 无法对技术有效单元进行进一步比较，且未考虑系统中的随机因素，可能导致在存在异常点时评估结果失真。

## DEA 相关概念

设有 $n$ 个部门或决策单元 （DMU），每个决策单元有 $m$ 个输入变量和 $q$ 个输出变量：
$$
\begin{array}{ccccccccc}
&&& m~\text{个投入} &&&& q~\text{个产出} \\
\text{DMU/指标}~ & ~x_1 & x_2 & \cdots & x_m~ & ~y_1 & y_2 & \cdots & y_q \\
1~ & ~x_{11} & x_{12} & \cdots & x_{1m}~ & ~y_{11} & y_{12} & \cdots & y_{1q} \\
2~ & ~x_{21} & x_{22} & \cdots & x_{2m}~ & ~y_{21} & y_{22} & \cdots & y_{2q} \\
\vdots~ & ~\vdots & \vdots & \ddots & \vdots~ & ~\vdots & \vdots & \ddots & \vdots \\
n~ & ~x_{n1} & x_{n2} & \cdots & x_{nm}~ & ~y_{n1} & y_{n2} & \cdots & y_{nq} \\
& \uparrow & \uparrow & \cdots & \uparrow~ & ~\uparrow & \uparrow & \cdots & \uparrow \\
\text{权重}~ & ~v_1 & v_2 & \cdots & v_m~ & ~ u_1 & u_2 & \cdots & u_m
\end{array}
$$
用 $i=1,\cdots,n$ 表示决策单元的索引；$j=1,\cdots,m$ 表示投入指标的索引；
$r=1,\cdots,q$ 表示产出指标的索引。

改用向量形式表示，记 
$$
X_i=[x_{i1},x_{i2},\cdots,x_{im}],\quad Y_i=[y_{i1},y_{i2},\cdots,y_{iq}],\quad i=1,\cdots,n 
$$
$$
v = [\nu_1,\cdots,\nu_m],\quad u =[u_1,\cdots,u_q]
$$
则 $X_i,Y_i$ 分别为第 $i$ 个决策单元的输入向量、输出向量；$v,u$ 分别为输入权重、输出权重。

DEA 评价的是技术效率，是指一个决策单元的生产过程达到本行业技术水平的程度。一般来说，技术效率可以使用产出和投入的比例衡量，但这种衡量方式一般仅适用于单投入单产出的情形。对于 $m$ 个投入和 $q$ 个产出，则第 $k$ 个决策单元的技术效率，可以用加权方式确定其综合的投入产出来刻画：
$$
h_k=\frac{\sum_{r=1}^qu_ry_{kr}}{\sum_{j=1}^m\nu_jx_{kj}}
$$
**关于投入与产出导向：**

在径向 DEA 中，无效率往往是通过投入和产出的等比例变化定义的，因此既可以在给定投入的情况下最大化产出（产出导向），也可以在给定产出的情况下最小化投入（投入导向）。

对于不同的规模收益假设，不同导向的效率分析结果可能存在一定差异。对于规模收益不变的模型（CRS），两种导向的效率结果是一样的；而对于可变规模收益模型（VRS）中，二者是不同的。

在实践中，投入和产出导向的选择没有明确的要求，实际选择时最好是根据具体生产活动的实际，看是投入倾向于固定不变还是产出倾向于固定不变。

**DEA 模型的编程实现：**

R 语言有 deaR 包等可以实现 DEA 模型。

手动编程实现的话，因为本质上就是求解线性规划问题，在模型公式确定后，其编程过程可遵循如下步骤：

(1) 确定参数列向量；
(2) 将模型表示为线性规划标准形式；
(3) 改成用矩阵语言表示，梳理出各矩阵、向量；
(4) 调用线性规划求解器进行求解。

## CCR模型 （规模收益不变假设下的径向 DEA 模型）

### 投入导向的 CCR 模型

在给定投入的条件下最大化产出。将前面加权方式的投入产出技术效率，再将其范围限制为 $[0,1]$，则得到投入导向的 CCR 模型：对每个决策单元 $k$，
$$
\begin{aligned}
&\max\frac{\sum_{r=1}^qu_ry_{kr}}{\sum_{j=1}^m v_jx_{kj}}\\
\mathbf{s.t.~~}&\frac{\sum_{r=1}^qu_ry_{kr}}{\sum_{j=1}^m v_jx_{kj}}\leq1\\
& v_j\geq0,u_r\geq0,\quad j=1,\cdots,m;\;r=1,\cdots q
\end{aligned}
$$

通过 Charnes-Cooper 变换线性化转化为线性规划：对每个决策单元 $k$，
$$
\begin{aligned}&\max\sum_{r=1}^q\mu_ry_{kr}\\\mathbf{s.t.~~}&\sum_{r=1}^q\mu_ry_{kr}-\sum_{j=1}^m \nu_jx_{kj}\leq0\\&\sum_{j=1}^m \nu_jx_{kj}=1\\&\mu_r\geq0, \nu_j\geq0,\quad j=1,\cdots,m; \; r=1,\cdots q\end{aligned}
$$

上述问题的对偶形式为（对偶模型的决策变量中包含效率值）： 对每个决策单元 $k$
$$
\begin{aligned}&\min\theta\\\mathrm{s.t.~~}&\sum_{i=1}^n\lambda_ix_{ij}\leq\theta x_{kj}\\&\sum_{i=1}^n\lambda_iy_{ir}\geq y_{kr}\\&\lambda_i\geq0,\quad j=1,\cdots,m;\;r=1,\cdots q\end{aligned}
$$

该对偶模型中，$\lambda_i,i=1,\cdots,n$ 表示 DMU 的线性组合系数，参数 $\theta$ 的最优解 $\theta^*$ 即为效率值，其范围落在 $[0,1]$。

该模型的含义相当于用加权方法构造出一个不存在的 DMU，其投入不大于待评价的 DMU，产出不小于待评价的 DMU，即
$$
x=\sum_{i=1}^n\lambda_ix_{ij},\quad y=\sum_{i=1}^n\lambda_ix_{ir}
$$

为了便于求解，进一步改写为矩阵形式：
$$
\begin{aligned}
&\min\left[0,\cdots,0,1\right]\left[\lambda_1,\cdots,\lambda_n,\theta\right]^T\\
\mathbf{s.t.}&\begin{bmatrix}x_{11}&x_{21}&\cdots&x_{n1}&-x_{i1}\\x_{12}&x_{22}&\cdots&x_{n2}&-x_{i2}\\
\vdots&\vdots&\ddots&\vdots&\vdots\\
x_{1m}&x_{2m}&\cdots&x_{nm}&-x_{im}\end{bmatrix}\begin{bmatrix}\lambda_1\\
\vdots\\
\lambda_n\\
\theta\end{bmatrix}\leqslant\begin{bmatrix}0\\
0\\
\vdots\\
0\end{bmatrix}\\
&\begin{bmatrix}-y_{11}&-y_{21}&\cdots&-y_{n1}&0\\
-y_{12}&-y_{22}&\cdots&-y_{n2}&0\\
\vdots&\vdots&\ddots&\vdots&\vdots\\
-y_{1q}&-y_{2q}&\cdots&-y_{nq}&0
\end{bmatrix}
\begin{bmatrix}
\lambda_1\\
\vdots\\
\lambda_n\\
\theta
\end{bmatrix}
\leqslant\begin{bmatrix}-y_{i1}\\
-y_{i2}\\
\vdots\\
-y_{iq}
\end{bmatrix}
\end{aligned}
$$

注意，模型的决策变量向量为 $[\lambda_{1}, \cdots, \lambda_{n}, \theta]^T$；两个系数矩阵的主体部分都是原始指标数据的转置，约束条件可以对应地按分块矩阵合并来写：
$$
\mathrm{s.t.}\quad \begin{bmatrix} X’\\ -Y’ \end{bmatrix}_{2\times1}\mathrm{\lambda}_{1\times1}\leqslant \begin{bmatrix}0\\-y’\end{bmatrix}_{2\times1}
$$

### 产出导向的 CCR 模型

在给定产出条件下最小化投入，具体推导过程略，只列出最终的对偶模型：对每个决策单元 $k$，
$$
\begin{aligned}&\max\phi\\\mathbf{s.t.~~}&\sum_{i=1}^n\lambda_ix_{ij}\leq x_{kj}\\&\sum_{i=1}^n\lambda_iy_{ir}\geq\phi y_{kr}\\&\lambda_i\geq0,\quad j=1,\cdots,m;\;r=1,\cdots q\end{aligned}
$$

该模型的效率为 $1 / \phi$。

### BCC模型（规模收益可变假设下的径向 DEA 模型）

在 DEA 模型中，对规模收益（RTS）的设定决定了前沿的形状，CCR 模型是假设规模收益不变（CRS），即模型中的 $\mathbf{\lambda}$ 满足 $\mathbf{\lambda} > 0$，此时生产可能集（DEA 技术集）为以 OB 射线为前沿面的集合：

```{r echo=FALSE, fig.cap="CRS 假设下的生产可能集", out.width="70%"}
knitr::include_graphics("figs/crs.png")
```


但在实际生产过程中，生产技术的规模收益并非 CRS，若采用 CRS 假设（CCR模型），得出的技术效率并非完全是纯技术效率，而是包含了规模效率成分的综合效率。

一般来说，生产技术的规模收益要先后经历规模收益递增（IRS）、规模收益不变（CRS）、规模收益递减（DRS）三个阶段。

如果无法确定研究样本处于哪个阶段，则评价技术效率时应选择规模收益可变（VRS）模型，即模型中的  $\mathbf{\lambda}$ 满足 $\sum \mathbf{\lambda} = 1$，此时生产可能集（DEA 技术集）为以线段 ABCD 以及 AD 往坐标轴的垂线为前沿（凸组合）：

```{r echo=FALSE, fig.cap="VRS 假设下生产可能集", out.width="80%"}
knitr::include_graphics("figs/vrs.png")
```

VRS 模型得出的技术效率是纯技术效率。

BCC 模型即规模收益可变（VRS）假设下的径向 DEA 模型，与 CCR 模型的区别就是增加了等式约束 $\sum \mathbf{\lambda} = 1$。

**投入导向的 BCC（对偶）模型**： 对每个决策单元 $k$，
$$
\begin{aligned}&\min\theta\\\mathbf{s.t.~~}&\sum_{i=1}^n\lambda_ix_{ij}\leq\theta x_{kj}\\&\sum_{i=1}^n\lambda_iy_{ir}\geq y_{kr}\\&\sum_{i=1}^n\lambda_i=1\\&\lambda_i\geq0,\quad j=1,\cdots,m;\;r=1,\cdots q\end{aligned}
$$

**产出导向的 BCC（对偶）模型**： 对每个决策单元 $k$，
$$
\begin{aligned}&\max\phi\\\mathbf{s.t.}&\sum_{i=1}^n\lambda_ix_{ij}\leq x_{kj}\\&\sum_{i=1}^n\lambda_iy_{ir}\geq\phi y_{kr}\\&\sum_{i=1}^n\lambda_i=1\\&\lambda_i\geq0,\quad j=1,\cdots,m;\; r=1,\cdots q\end{aligned}
$$

### 带非期望产出的 SBM 模型

在径向模型中，效率改善主要指的是投入或产出的等比例线性放缩，同时忽略了平行于坐标轴的弱有效的情形，而 SBM 模型纳入无效率的松弛改进，保证最终的结果是强有效的。

**标准 SBM 模型**形式为： 对每个决策单元 $k$，
$$
\begin{aligned}&\min\rho=\frac{1-\frac{1}{m}\sum_{j=1}^ms_j^-/x_{kj}}{1+\frac{1}{q}\sum_{r=1}^qs_r^-/y_{kj}}\\ \mathbf{s.t.~~}&X\lambda+s^-=x_k\\&Y\lambda-s^{+}=y_{k}\\&\lambda,s^-,s^+\geq0,\quad j=1,\cdots,m;\; r=1,\cdots,q\end{aligned}
$$

该模型旨在通过最小化投入的相对减少量和最大化期望产出的相对增加量来衡量效率。目标函数最优解中 $\rho^*$ 表示效率值，该模型同时从投入和产出两个方面考察无效率的表现，故称为非径向模型。

若同时加入非期望产出，则得到**带非期望产出的 SBM 模型**：对每个决策单元 $k$，
$$
\begin{aligned} & \min \rho = \frac{1 - \frac{1}{m} \sum_{i=1}^m \frac{s_i^-}{x_{ik}}}{1 + \frac{1}{q+b} \left( \sum\limits_{r=1}^q \frac{s_r^g}{y_{rk}^g} + \sum\limits_{t=1}^b \frac{s_t^b}{y_{tk}^b} \right)} \\ \mathbf{s.t.~~}& X\lambda + s^- = x_k \\ & Y^g\lambda - s^g = y_k^g \\ & Y^b\lambda + s^b = y_k^b \\ & \lambda, s^-, s^g, s^b \geq 0, \quad i=1,\ldots,m; r=1,\ldots,q; t=1,\ldots,b \end{aligned}
$$
其中，$m,q,b$ 分别为投入、期望产出、非期望产出的数量；

$s^-,s^g,s^b$ 分别为投入、期望产出和非期望产出的松弛变量；

$x_k,y_k^g,y_k^b$ 分别为第$k$个 DMU 的投入、期望产出和非期望产出；

$X,Y^g,Y^b$ 分别为投入、期望产出和非期望产出的数据矩阵；

$\lambda$ 为权重向量。

### 超效率模型

在传统的 DEA 模型中，效率前沿上的决策单元（DMU）都会被赋予效率值 $1$，这意味着这些单位都被视为“最优”或“有效”的代表。然而，这种设定也带来了一个问题：无法进一步区分这些高效单元之间的相对表现。

**超效率模型**正是为了解这一问题而提出的。其核心思想是：将原本处于效率前沿的某个 DMU 从参考集中移除，再评估它在其余 DMU 所构成的新前沿面上的表现。这样做的结果是，原本效率为 $1$ 的 DMU 现在可能会得到一个大于 $1$ 的效率值，从而反映出它在“超越现有最佳实践”时的表现。

换句话说，**超效率模型不是重新评估谁是有效的，而是衡量那些已经被认为是有效的 DMU 之间，谁更胜一筹**。这使得我们可以在不改变原有 DEA 基本框架的前提下，对高效单元进行排序和深入比较，尤其适用于需要甄选标杆或识别领先实践者的场景。

超效率模型在实际应用中非常有用，例如在绩效评估、资源分配、政策制定等方面，帮助决策者识别真正具有引领作用的个体，并据此推广先进经验。

以**投入导向的 BCC（对偶）模型**改写为超效率模型为例：对每个决策单元 $k$，
$$
\begin{aligned} & \min \theta \\ \text{s.t.} \quad & \sum_{\substack{i=1\\i \neq k}}^n \lambda_i x_{ij} \leq \theta x_{kj}, \quad j = 1, \cdots, m \\ & \sum_{\substack{i=1\\i \neq k}}^n \lambda_i y_{ir} \geq y_{kr}, \quad r = 1, \cdots, q \\ & \sum_{\substack{i=1\\i \neq k}}^n \lambda_i = 1, \\  &\lambda_i \geq 0, \quad i \neq k \end{aligned}
$$


## DEA 案例

加载包：

```{r message=FALSE}
library(tidyverse)
library(mathmodels)
```

`mathmodels` 包对 `deaR` 包中的相应函数做了封装，提供了四个函数：`basic_DEA`、`super_DEA`、`basic_SBM` 和 `super_SBM`，分别适用于不同类型的 DEA 或 SBM 模型变体：径向数据包络分析（DEA）模型（Charnes 等，1978；Banker 等，1984）和基于松弛变量测度的 SBM 模型（Tone，2001）计算效率得分提供了简化的操作接口，支持在规模报酬不变（CRS）或规模报酬可变（VRS）条件下，运行标准模型和超效率模型，并可选择性地处理非期望产出。

基本语法为（同其它函数）：

```{r eval=FALSE}
basic_DEA(data, inputs, outputs, ud_outputs = NULL,
          orientation = "io", rts = "vrs")
```

- `data`：数据框，第 1 列为 DMU 名字；
- `inputs/outputs`（包含 `ud_outputs`）：投入、产出的列名或列索引；
- `ud_outputs`：非期望产出位于产出中的位置索引，默认为 `NULL`；
- `orientation`：设置导向：`"io"`（默认，投入导向）、`"oo"`（产出导向）；
- `rts`：设置规模收益：`"crs"（不变规模收益）、`"vrs"`（默认，可变规模收益）。

**案例数据：**2011 年各省（市、自治区）医院的部分投入和产出指标。以床位数和卫生技术人员数作为投入，以诊疗人次数和入院人数作为产出，（可选）医疗废弃物作为非期望产出。

```{r}
df = readxl::read_excel("data/dea-data.xlsx")
df
```

先以投入导向、VRS 假设下的 DEA 模型（BCC）为例，不考虑非期望产出：

```{r}
bbc_in = basic_DEA(df, inputs = 2:3, outputs = 4:5, 
                   orientation = "io", rts = "vrs")
```

- 查看各 DMU 效率值

```{r}
bbc_in$efficiencies
```

- `bbc_in` 对象中还包含其它结果（略）：

```{r eval=FALSE}
bbc_in$slacks      # 松弛变量
bbc_in$lambdas     # 权重
bbc_in$targets     # 目标值
bbc_in$references  # 参照单元
bbc_in$returns     # 规模收益
```

- **松弛变量（$\mathbf{s}$）：**衡量投入过度或产出不足的程度，反映决策单元在哪些方面可以进一步优化：
  - 投入松弛 = 实际投入 - 目标投入
  - 产出松弛 = 目标产出 - 实际产出

- **权重（$\mathbf{\lambda}$）：**表示参考单元的权重，用于构建效率前沿；每个 DMU 的效率值由其参考单元的线性组合计算：
  - 对于非有效 DMU（效率值 $< 1$），$\lambda$ 表示它应该向哪些有效 DMU（效率值 $= 1$）学习，$\lambda > 0$ 的 DMU 是其参考单元

- **目标值：** DMU 达到 DEA 有效时应有的投入和产出水平；对非有效 DMU，目标值 = 参考单元的加权组合：
  - 投入目标 = 实际投入 - 投入松弛
  - 产出目标 = 实际产出 + 产出松弛

- **参照单元：**效率前沿上的 DMU，非有效 DMU 通过模仿它们来提高效率；$\lambda > 0$ 的 DMU。

- **规模收益：**表示 DMU 的规模效率，基于 VRS 模型的 $\lambda$ 值之和：
  - irs（$\sum \lambda < 1$）：规模报酬递增（扩大规模可提升效率）
  - drs（$\sum \lambda > 1$）：规模报酬递减（规模过大导致效率下降）
  - crs（$\sum \lambda = 1$）：规模报酬不变（最优规模）
  
若计算同样设置下的超效率：

```{r}
res = super_DEA(df, inputs = 2:3, outputs = 4:5, 
                orientation = "io", rts = "vrs")
res$efficiencies
```

注意，有些 DMU 的超效率为 `NA`，对应其线性规划模型无可行解，一种处理办法是将其替换为标准 DEA 效率值：

```{r}
idx = is.na(res$efficiencies)
res$efficiencies[idx] = bbc_in$efficiencies[idx]
res$efficiencies
```

最后，再计算另外四种 DEA 效率：

```{r}
ccr_in = basic_DEA(df, inputs = 2:3, outputs = 4:5, 
                   orientation = "io", rts = "crs")
ccr_out = basic_DEA(df, inputs = 2:3, outputs = 4:5, 
                   orientation = "oo", rts = "crs")
bbc_out = basic_DEA(df, inputs = 2:3, outputs = 4:5, 
                   orientation = "oo", rts = "vrs")
sbm_ud_out = basic_SBM(df, inputs = 2:3, outputs = 4:6, ud_outputs = 3,
                       orientation = "oo", rts = "vrs")
```

合并结果，并计算规模效率（CRS 效率 = VRS 效率 * 规模效率）：

```{r}
tibble(DMU = df$DMU, ccr_in = ccr_in$efficiencies, 
       ccr_out = ccr_out$efficiencies, 
       bbc_in = bbc_in$efficiencies, 
       bbc_out = bbc_out$efficiencies, 
       sbm_ud_out = sbm_ud_out$efficiencies,
       scale_eff = ccr_in / bbc_in)
```

更多的 DEA 模型还有：考虑不同时期效率变化的 DEA-malmquist 模型；考虑环境因素和随机噪声对决策单元效率影响的三阶段 DEA 模型；固定前沿生产函数的参数法随机前沿模型；以及以效率为因变量研究效率的影响因素的 Tobit 回归模型。
